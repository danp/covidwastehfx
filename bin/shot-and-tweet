#!/bin/bash

set -eo pipefail

latest="$(curl --fail https://health-infobase.canada.ca/src/data/covidLive/wastewater/covid19-wastewater.csv | grep Halifax | sort | tail -n1 | cut -d, -f1)"
if cmp -s <(echo "$latest") latest-date && [ "$GITHUB_REF_NAME" = "main" ]; then
    exit 0
fi
echo "$latest" > latest-date

last_year="$(date --date="$latest - 1 year" +"%Y-%m-%d")"

region=""
for _ in 0 1 2 3; do
    region="$(shot-scraper javascript -b firefox https://health-infobase.canada.ca/covid-19/wastewater/ 'Array.from(document.querySelectorAll("optgroup > option.siteOption")).filter(v => (v.text == "Halifax"))[0]?.value' | jq -r '. // ""')"
    [ "$region" != "" ] && break
    sleep 10
done
if [ "$region" = "" ]; then
    echo "Couldn't figure out the Halifax region id." >&2
    exit 1
fi

url="https://health-infobase.canada.ca/covid-19/wastewater/?dateSel=customrange&regions=${region}&sdate=${last_year}&edate=${latest}&sort=asc&grid=1&showDailyValues=false"
echo "$url"

worked=0
for _ in 0 1 2 3; do
    if shot-scraper -o /tmp/covid.png --retina -b firefox --selector-all '#graph-container > div > div' "$url"; then
        worked=1
        break
    fi
    sleep 10
done
if [ $worked -eq 0 ]; then
    exit 1
fi

if [ "$GITHUB_REF_NAME" != "main" ]; then
    exit 0
fi

tweet-images "COVID wastewater charts for the Halifax area as of $latest $url" \
             /tmp/covid.png --alt "Screenshot of the charts" > latest-tweet.md
